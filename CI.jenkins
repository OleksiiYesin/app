#!groovy
pipeline {
    agent {
        label "static_slave"
    }
    stages {
        stage('hello') {
            steps {
              echo "Hello from MAIN branch!"
            }
        }

        stage("Install docker") {
            steps {
                echo " ============== Installing docker =================="
                dir ('.') {
                    sh 'sudo chmod +x scripts/docker_install.sh'
                	sh 'sudo ./scripts/docker_install.sh'
                }
            }
        }

        stage("create docker image") {
            steps {
                echo " ============== Start building image =================="
                dir ('.') {
                	sh 'sudo docker build -t yesinaleksey/app:v1 .'
                }
            }
        }

        stage("docker login") {
            steps {
                echo " ============== Docker login =================="
                withCredentials([usernamePassword(credentialsId: 'dockerhub-key', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                	sh 'sudo docker login -u $USERNAME -p $PASSWORD'
                }
            }
        }

        stage("docker push") {
            steps {
                echo "============== Start push container =================="
                dir ('.') {
                	sh 'sudo docker push yesinaleksey/app:v1'
                }
            }
        }
    }
}